function CallPayment3(){var i=!1,n,t,r,u;try{(getParameterByName("RequestId")!=""||getParameterByName("PaymentResultKey")!="")&&(i=!0);i?(StartBusy("DivPayment","در حال ارجاع به سایت..."),n=getParameterByName("RequestId"),t=getParameterByName("PaymentResultKey"),n!=""?(r={RequestId:n,EncUrl:getParameterByName2("ReturnValue")},u=JSON.stringify(r),$.ajax({type:"POST",url:"USHowFishj.aspx/GetDecryptUrl",data:u,crossDomin:!0,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,success:function(t){var i=t.d.Result,r=GetLocalStorage("ClsPaymentInfo"),u;r!=null&&r!="null"&&(ClsPaymentInfo=JSON.parse(r));ClsPaymentInfo.TrackingCode=i.TrackingCode;ClsPaymentInfo.IsTruePayment=i.IsPayment;(ClsPaymentInfo.FicheNo==undefined||ClsPaymentInfo.FicheNo=="")&&(ClsPaymentInfo.FicheNo=i.FicheNo);ClsPaymentInfo.NidFK=i.NidFK;ClsPaymentInfo.BackFromBank=i.BackFromBank;u=JSON.stringify(ClsPaymentInfo);localStorage.removeItem("ClsPaymentInfo");SetLocalStorage("ClsPaymentInfo-"+n,u);BackFunc()},error:function(){}})):t!=""&&verifyApiKey(t)):typeof BankPaymentNew=="undefined"?GetSignature():GetEsupSignatureEnc()}catch(f){}}function EncryptInput(n){var t,i;t=JSON.stringify(n);const r=CryptoJS.AES.encrypt(t,"./../store/index").toString();return i={pdata1:r},JSON.stringify(i)}function verifyApiKey(n){var i={ApiKey:n},t=EncryptInput(i);$.ajax({type:"POST",url:WEsupAddress+"/verifyApiKey",data:t,crossDomin:!0,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,success:function(t){var u=t.data,r=GetLocalStorage("ClsPaymentInfo"),i,f;r!=null&&r!="null"&&(ClsPaymentInfo=JSON.parse(r));u.Status=="verified"&&(i=JSON.parse(u.item.StrValue),i.paymentStatus==!0&&(ClsPaymentInfo.TrackingCode=i.rahgiriCode,ClsPaymentInfo.IsTruePayment=!0,i.ficheNo!=null&&i.ficheNo!=""&&(ClsPaymentInfo.FicheNo=i.ficheNo),ClsPaymentInfo.NidFK=i.bizCode));ClsPaymentInfo.BackFromBank=!0;f=JSON.stringify(ClsPaymentInfo);localStorage.removeItem("ClsPaymentInfo");SetLocalStorage("ClsPaymentInfo-"+n,f);BackFunc()},error:function(n){console.log(n);console.log(WEsupAddress+"/verifyApiKey");console.log(t)}})}function GetSignature(){StartBusy("DivPayment","در حال ارجاع به صفحه بانک...");$.ajax({type:"POST",url:"USHowFishj.aspx/GetSignature",crossDomin:!0,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,success:function(n){RequestGuid=n.d.Result.RequestID;EncryptCode=n.d.Result.EncryptCode;GotoBank()},error:function(){GotoBank()}})}function GetEsupSignature(){var i=ClsPaymentInfo.NosaziCode.split("-")[0],n,t;StartBusy("DivPayment","در حال ارجاع به صفحه بانک...");n={StrValue:'{"Price":"'+ClsPaymentInfo.Price+'","billID":"'+ClsPaymentInfo.BillID+'","paymentID":"'+ClsPaymentInfo.PaymentID+'","paymentType":"'+ClsPaymentInfo.PaymentType+'","ficheType":"'+ClsPaymentInfo.FicheType+'","IbanNumber":"'+ClsPaymentInfo.IbanNumber+'","district":"'+i+'","gatewayName":"'+GatewayName+'","ficheNo":"'+ClsPaymentInfo.FicheNo+'","requesterKey":"'+ClsPaymentInfo.NidNosaziCode+'","bizCode":"'+ClsPaymentInfo.NidNosaziCode+'","appNameId":"1","userId":"'+ClsAccount.AccountInfo.NidAccount+'","mobile":"'+ClsAccount.AccountInfo.OwnerTell+'","siteCallBackUrl":"'+window.location.origin+"/"+window.location.pathname+'"}'};t=JSON.stringify(n);$.ajax({type:"POST",url:WEsupAddress+"/GenerateApiKey",crossDomin:!0,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,data:t,success:function(n){ClsPaymentInfo.TokenGuid=n.data;RequestId=ClsPaymentInfo.TokenGuid;GotoBankNew()},error:function(){GotoBankNew()}})}function GetEsupSignatureEnc(){var r=ClsPaymentInfo.NosaziCode.split("-")[0],t,i,n;StartBusy("DivPayment","در حال ارجاع به صفحه بانک...");t={StrValue:'{"Price":"'+ClsPaymentInfo.Price+'","billID":"'+ClsPaymentInfo.BillID+'","paymentID":"'+ClsPaymentInfo.PaymentID+'","paymentType":"'+ClsPaymentInfo.PaymentType+'","ficheType":"'+ClsPaymentInfo.FicheType+'","IbanNumber":"'+ClsPaymentInfo.IbanNumber+'","district":"'+r+'","gatewayName":"'+GatewayName+'","ficheNo":"'+ClsPaymentInfo.FicheNo+'","requesterKey":"'+ClsPaymentInfo.NidNosaziCode+'","bizCode":"'+ClsPaymentInfo.NidNosaziCode+'","appNameId":"1","userId":"'+ClsAccount.AccountInfo.NidAccount+'","mobile":"'+ClsAccount.AccountInfo.OwnerTell+'","siteCallBackUrl":"'+window.location.origin+"/"+window.location.pathname+'"}'};n=JSON.stringify(t);const u=CryptoJS.AES.encrypt(n,"./../store/index").toString();i={pdata1:u};n=JSON.stringify(i);$.ajax({type:"POST",url:WEsupAddress+"/GenerateApiKey",crossDomin:!0,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,data:n,success:function(n){n.success==!0?(ClsPaymentInfo.TokenGuid=n.data,RequestId=ClsPaymentInfo.TokenGuid,GotoBankNew()):alert("خطا در تابع GenerateApiKey، لطفا به راهبر سیستم اطلاع دهید")},error:function(){GotoBankNew()}})}function GotoBank(){var n=document.referrer,t,i,r;n.indexOf("IsPayment=")>-1&&(n=n.substr(0,n.indexOf("IsPayment=")-1));n.indexOf("RequestId=")>-1&&(n=n.substr(0,n.indexOf("RequestId=")-1));UGPReturnUrl=n;ClsPaymentInfo.ReturnUrl=n;t=JSON.stringify(ClsPaymentInfo);SetLocalStorage("ClsPaymentInfo",t);i=location.search.replace("DutyType=5","DutyType=4");ClsPaymentInfo.FicheType==EumFicheType.HK?(r=location.origin+location.pathname,window.open(BankPaymentKarshenasi+location.search+"&RequestGuid="+RequestGuid+"&PEncryptCode="+EncryptCode+"&Comment=","_self","width =800, height =600 ,resizable=yes")):ClsPaymentInfo.FicheType==EumFicheType.Nosazi||ClsPaymentInfo.FicheType==EumFicheType.Pasmand?window.open(BankPaymentAddress+location.search+"&RequestGuid="+RequestGuid+"&PEncryptCode="+EncryptCode,"_self"):window.open(BankPaymentDarAmad+i+"&RequestGuid="+RequestGuid+"&PEncryptCode="+EncryptCode,"_self")}function GotoBankNew(){var n=document.referrer,t,i;n.indexOf("IsPayment=")>-1&&(n=n.substr(0,n.indexOf("IsPayment=")-1));n.indexOf("RequestId=")>-1&&(n=n.substr(0,n.indexOf("RequestId=")-1));UGPReturnUrl=n;ClsPaymentInfo.ReturnUrl=n;t=JSON.stringify(ClsPaymentInfo);SetLocalStorage("ClsPaymentInfo",t);i=BankPaymentNew+"?ApiKey="+ClsPaymentInfo.TokenGuid;window.open(i,"_self")}function BackFunc(){var t=ClsPaymentInfo.ReturnUrl,i=location.search,n,r;t.indexOf("?")>-1&&(i=i.replace("?","&"));n=t+i;ClsPaymentInfo.NosaziCode!=""&&(n+="&NosaziCode="+ClsPaymentInfo.NosaziCode);r=ClsPaymentInfo.SessionId+"Lsppp";n+="&S="+window.btoa(r);SavePaymentLog();n=n.replace("PaymentResultKey","RequestId");t!=""&&window.open(n,"_self")}function SavePaymentLog(){if(ClsPaymentInfo.TrackingCode!=null&&ClsPaymentInfo.TrackingCode!=""&&ClsPaymentInfo.FicheType!="0"){var n={pPaymentLog:ClsPaymentInfo},t=JSON.stringify(n);$request=$.ajax({type:"POST",url:"UShowPayments.aspx/InsertPaymentLog",data:t,crossDomin:!0,contentType:"application/json; charset=utf-8",dataType:"json",processdata:!0,success:function(){},error:function(){}})}}function getParameterByName(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+n+"=([^&#]*)"),t=i.exec(location.search);return t===null?"":decodeURIComponent(t[1].replace(/\+/g," "))}function getParameterByName2(n){n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+n+"=([^&#]*)"),t=i.exec(location.search);return t===null?"":decodeURIComponent(t[1])}function string_of_enum(n,t){for(var i in n)if(n[i]==t)return i=="Nosazi"?i="عوارض نوسازی":i=="Pasmand"?i="عوارض پسماند":i=="Daramad"?i="عوارض درآمد":i=="HK"?i="هزینه کارشناسی":i=="Senfi"&&(i="عوارض صنفی"),i;return null}var RequestGuid="3786055d-5875-4e79-b1e2-07dbff0578da",PEncryptCode="RgnyspwPLUSxnXDKGbYb9vkOwEQUALEQUAL",tmpSelectedBank=null,ClsPaymentInfo={PaymentType:1,FicheType:1,PaymentTitle:"",Price:"",NidAccount:"",AccountName:"",NidUser:"",FullUserName:"",NidVisitor:"",VisitorName:"",NidWorkItem:"",TrackingCode:"",IsTruePayment:!1,Description:"",NosaziCode:"",SelectedBankId:BankInfo.SelectedID,BankName:"",IsBackFromBank:!1,BillID:"",PaymentID:"",ReturnUrl:"",FicheNo:"",NidNosaziCode:"",IbanNumber:""},EumFicheType={Nosazi:1,Senfi:2,Pasmand:3,Daramad:4,HK:0};$(document).ready(function(){ClsPaymentInfo.NidAccount=ClsAccount.AccountInfo!=null?ClsAccount.AccountInfo.NidAccount:"";ClsPaymentInfo.AccountName=ClsAccount.AccountInfo!=null?ClsAccount.AccountInfo.OwnerFirstName+" "+ClsAccount.AccountInfo.OwnerLastName+"( "+ClsAccount.AccountInfo.AccountName+" )":"";ClsPaymentInfo.NidUser=ClsAccount.UserInfo.NidUser!=null?ClsAccount.UserInfo.NidUser:"";ClsPaymentInfo.FullUserName=ClsAccount.UserInfo.NidUser!=null?ClsAccount.UserInfo.FirstName+" "+ClsAccount.UserInfo.LastName+"( "+ClsAccount.UserInfo.UserName+" )":"";ClsPaymentInfo.SessionId=ClsAccount.SessionId;ClsPaymentInfo.BillID=getParameterByName("BillID");ClsPaymentInfo.PaymentID=getParameterByName("PayID");ClsPaymentInfo.Price=getParameterByName("Price");ClsPaymentInfo.Price==""&&(ClsPaymentInfo.Price=getParameterByName("Amount"));ClsPaymentInfo.FicheType=getParameterByName("DutyType");ClsPaymentInfo.PaymentTitle=string_of_enum(EumFicheType,ClsPaymentInfo.FicheType);ClsPaymentInfo.NosaziCode=getParameterByName("NosaziCode");ClsPaymentInfo.NidWorkItem=getParameterByName("NidWorkItem");ClsPaymentInfo.FicheNo=getParameterByName("FicheNo");ClsPaymentInfo.NidNosaziCode=getParameterByName("NidNosaziCode");ClsPaymentInfo.NidNosaziCode==""&&(ClsPaymentInfo.NidNosaziCode=getParameterByName("NidFK"));ClsPaymentInfo.FicheType==EumFicheType.HK&&(ClsPaymentInfo.PaymentType=2);ClsPaymentInfo.IbanNumber=getParameterByName("IbanNumber");var t=BankInfo.SelectedID,n=getParameterByName("SelectedBank");n!=""&&n!=undefined&&n!="undefined"&&(t=n);tmpSelectedBank=BankInfo.BankList.find(n=>n.ID==t);tmpSelectedBank!=null&&(BankPaymentAddress=tmpSelectedBank.BankUrl,ClsPaymentInfo.BankName=tmpSelectedBank.BankName);CallPayment3()});