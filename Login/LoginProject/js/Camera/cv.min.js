var Point=function(n,t){this.x=n;this.y=t},Blob,UnionFind;Point.prototype={getX:function(){return parseInt(this.x)},getY:function(){return parseInt(this.y)},toList:function(){return[parseInt(this.x),parseInt(this.y)]},mult:function(n){return new Point(parseInt(this.x)*n,parseInt(this.y)*n)},add:function(n){return new Point(parseInt(this.x)+parseInt(n.x),parseInt(this.y)+parseInt(n.y))},sub:function(n){return new Point(parseInt(this.x)-parseInt(n.x),parseInt(this.y)-parseInt(n.y))},div:function(n){return new Point(parseInt(parseInt(this.x)/n),parseInt(parseInt(this.y)/n))},distTo:function(n){return Math.sqrt(Math.pow(parseInt(this.x)-parseFloat(n.x),2)+Math.pow(parseInt(this.y)-parseFloat(n.y),2))},getVal:function(n){return n==0?x:n==1?y:undefined}};Blob=function(n,t,i,r){this.centroid=n;this.contour=t;this.contourArea=i;this.bbox=r};Blob.prototype={getCentroid:function(){return this.centroid},getContour:function(){return this.contour},getContourArea:function(){return this.contourArea},getBbox:function(){return this.bbox}};UnionFind=function(){this.leader={};this.group={}};UnionFind.prototype={add:function(n,t){var i,r,f,e,u;if(t==undefined){this.leader[n]==undefined&&(this.leader[n]=n,this.group[n]=[],this.group[n].push(n));return}if(i=this.leader[n],r=this.leader[t],i!=undefined)if(r!=undefined){if(i==r)return;for(f=this.group[this.leader[i]],e=this.group[this.leader[r]],this.leader[t]=i,f.push.apply(f,e),delete this.group[r],u=0;u<e.length;u++)this.leader[u]=i}else this.group[i]==undefined?this.group[this.leader[i]].push(t):this.group[i].push(t),this.leader[t]=i;else r!=undefined?(this.group[r].push(n),this.leader[n]=r):(this.leader[n]=this.leader[t]=n,this.group[n]=[t])},getLeaders:function(){return this.leader},getLeader:function(n){return this.leader[n]},getGroups:function(){return this.group},getGroup:function(n){return this.group[n]},getGroupList:function(){var n=[];for(var t in this.group)n.push(this.group[t]);return n}};var containsRect=function(n,t){return t[0]>=n[0]&&t[1]>=n[1]&&t[0]+t[2]<=n[0]+n[2]&&t[1]+t[3]<=n[1]+n[3]},intersectsRect=function(n,t){return!(t[0]>n[0]+n[2]||t[0]+t[2]<n[0]||t[1]>n[1]+n[3]||t[1]+t[3]<n[1])},rectsInDistance=function(n,t,i){return Math.abs(n[0]-t[0])<=i&&Math.abs(n[1]-t[1])<=i},getRectCenter=function(n){return[(n[0]+n[2])/2,(n[1]+n[3])/2]},rectRound=function(n){n[0]=Math.round(n[0]);n[1]=Math.round(n[1]);n[2]=Math.round(n[2]);n[3]=Math.round(n[3])},groupRects=function(n){for(var i,t=n.length-1;t>=0;t--)for(i=t-1;i>=0;i--)if(containsRect(n[t],n[i])){n.splice(t,1);break}else if(containsRect(n[i],n[t])){n[i]=n[t];n.splice(t,1);break}else if(intersectsRect(n[i],n[t])){var r=Math.min(n[t][0],n[i][0]),u=Math.min(n[t][1],n[i][1]),f=Math.max(n[t][0]+n[t][2],n[i][0]+n[i][2]),e=Math.max(n[t][1]+n[t][3],n[i][1]+n[i][3]);n[i]=[r,u,f-r,e-u];n.splice(t,1);break}},toGrayscale=function(n){var t=new jsfeat.matrix_t(n.width,n.height,jsfeat.U8_t|jsfeat.C1_t);return jsfeat.imgproc.grayscale(n.data,n.width,n.height,t),t},toBinary=function(n,t,i,r){binary=new jsfeat.matrix_t(n.cols,n.rows,jsfeat.U8_t|jsfeat.C1_t);binary.data.set(n.data);for(var u=0;u<binary.data.length;u++)binary.data[u]=binary.data[u]>=t&&binary.data[u]<=i?!r?255:0:!r?0:255;return binary},toImageData=function(n,t,i){for(var f=new Uint8ClampedArray(t*i*4),e=new Uint32Array(f.buffer),u=n.cols*n.rows,r=0;--u>=0;)r=n.data[u],e[u]=-16777216|r<<16|r<<8|r;return{width:t,height:i,data:f}},getPixelNeighborhood=function(n,t,i){for(var f=[],u=[[-1,-1],[0,-1],[1,-1],[-1,0]],r=0;r<u.length;r++)pIndex=(i+u[r][1])*n.cols+t+u[r][0],t+u[r][0]<n.cols&&t+u[r][0]>=0&&i+u[r][1]<n.rows&&i+u[r][1]>=0&&n.data[pIndex]>0&&f.push(pIndex);return f},getMoments=function(n,t,i,r){for(var e,f,l=[],u=0;u<n.length;u++)if(e=n[u].length,e>r){var a=0,v=0,o=t,s=i,h=0,c=0;for(f=0;f<e;f++)a+=n[u][f]%t,v+=Math.floor(n[u][f]/t),o=Math.min(o,n[u][f]%t),s=Math.min(s,Math.floor(n[u][f]/t)),h=Math.max(h,n[u][f]%t),c=Math.max(c,Math.floor(n[u][f]/t));l.push(new Blob(new Point((a/e).toFixed(0),(v/e).toFixed(0)),n[u],e,[o,s,h-o,c-s]))}return l},getConnectedComponents=function(n,t){for(var o,u,l,r,h,f,i=new UnionFind,e=jsfeat.cache.get_buffer(n.cols*n.rows),c=-1,s=0;s<n.rows;s++)for(o=0;o<n.cols;o++)if(u=s*n.cols+o,n.data[u]!=0)if(l=getPixelNeighborhood(n,o,s),r=l.filter(function(n){return e.data[n]!=undefined}).map(function(n){return e.data[n]}),r.length==0)e.data[u]=c,i.add(c,u),c--;else for(h=Math.max.apply(null,r),e.data[u]=h,i.add(i.getLeader(h),u),f=0;f<r.length;f++)i.getLeader(r[f])!=undefined&&i.getGroup(r[f])==undefined||i.add(i.getLeader(h),i.getLeader(r[f]));return jsfeat.cache.put_buffer(e),getMoments(i.getGroupList(),n.cols,n.rows,t)},fillContour=function(n,t,i){t.forEach(function(t){n.data[4*t]=i[0];n.data[4*t+1]=i[1];n.data[4*t+2]=i[2]})},cropImageData=function(n,t,i,r,u){for(var e=new Uint8ClampedArray(r*u*4),f=i,o=0;f<i+u;f++,o++)e.set(n.data.subarray((f*n.width+t)*4,(f*n.width+t+r)*4),o*r*4);return{width:r,height:u,data:e}};