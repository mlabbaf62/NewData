var FaceDetector=function(n){var c=this;c.options=n;var nt=180,tt=c.options.divContainer,r,e,i,f=0,o=0,v,w=!1,t={startTime:0,endTime:0,faces:[]},u={startTime:0,endTime:0,faces:[]},b="",y=c.options.blinksThreshold===undefined?2:c.options.blinksThreshold,it=50,k=50,s=[255,0,0],l=!1,h,p,ft=function(){var n=document.createElement("div"),t,o,u,f;n.style.cssText="margin: 0 auto; padding: 0; text-align:center;";r=document.createElement("video");r.style.cssText="display: none;";n.appendChild(r);t=document.createElement("canvas");e=t.getContext("2d");t.style.cssText="display: none;";n.appendChild(t);o=document.createElement("canvas");i=o.getContext("2d");n.appendChild(o);u=document.createElement("div");u.className="DivFace"; u.style.cssText="display: table; vertical-align: middle;";u.appendChild(n);f=document.createElement("div");f.style.cssText="position: absolute; display: table; width: 100%; height: 100%;";f.appendChild(u);tt.appendChild(f)},a=function(n,r,u){i.fillStyle="rgba(50, 50, 50, 0.7)";i.fillRect(n.rect[0]+5,n.rect[1]+n.rect[3]-40,n.rect[2]-10,35);i.font="26px Tahoma";i.fillStyle="rgba(255, 255, 255, 1.0)";i.fillText(r,t.faces[0].rect[0]+t.faces[0].rect[2]/2-u,t.faces[0].rect[1]+t.faces[0].rect[3]-15)},d=function(n){for(var i=0,t=0;t<n.eyes.length;t++)i+=n.eyes[t].blobs.length;return i},et=function(){var u=Math.max(t.faces[0].rect[0]-t.faces[0].rect[2]/4,0),h=Math.min(t.faces[0].rect[0]+t.faces[0].rect[2]+t.faces[0].rect[2]/4,f),s=Math.max(t.faces[0].rect[1]-t.faces[0].rect[3]/4,0),c=Math.min(t.faces[0].rect[1]+t.faces[0].rect[3]+t.faces[0].rect[3]/4,o),l=Math.round(u),a=Math.round(s),v=Math.round(h-u),y=Math.round(c-s),n=Math.min(v,y),i=document.createElement("canvas"),r;i.width=n;i.height=n;i.getContext("2d").drawImage(e.canvas,l,a,n,n,0,0,n,n);r=document.createEvent("CustomEvent");r.initCustomEvent("facedetected",!0,!0,{face:i,face64:i.toDataURL("image/jpeg").replace(/^data:image\/(jpg|jpeg);base64,/,"")});tt.dispatchEvent(r)},g=function(){s=[255,0,0];blinks=0},ot=function(){t.faces.length===1&&u.faces.length===1&&Math.abs(t.faces[0].rect[0]-u.faces[0].rect[0])<=it&&Math.abs(t.faces[0].rect[1]-u.faces[0].rect[1])<=it?(s=[Math.max(s[0]-100,0),Math.min(s[1]+100,255),s[2]],(t.faces[0].eyes.length===1&&u.faces[0].eyes.length===1&&rectsInDistance(t.faces[0].eyes[0].rect,u.faces[0].eyes[0].rect,k)&&t.faces[0].eyes[0].blobs.length===0&&u.faces[0].eyes[0].blobs.length===1||t.faces[0].eyes.length===2&&u.faces[0].eyes.length===2&&rectsInDistance(t.faces[0].eyes[0].rect,u.faces[0].eyes[0].rect,k)&&rectsInDistance(t.faces[0].eyes[1].rect,u.faces[0].eyes[1].rect,k)&&d(t.faces[0])<d(u.faces[0]))&&(blinks=Math.min(blinks+1,y))):g()},st=function(n){for(var o,u,h,c,r,a,l,f,v,e=0;e<t.faces.length;e++)for(o=t.faces[e],u=o.rect,i.beginPath(),i.lineWidth=5,i.strokeStyle="rgba("+s[0]+", "+s[1]+", "+s[2]+", 0.7)",i.rect(u[0],u[1],u[2],u[3]),i.stroke(),h=0;h<o.eyes.length;h++){for(c=o.eyes[h],r=c.rect,i.beginPath(),i.lineWidth=1,i.strokeStyle="rgba(0, 255, 0, 0.3)",i.rect(r[0]+u[0],r[1]+u[1],r[2],r[3]),i.stroke(),a=cropImageData(n,r[0]+u[0],r[1]+u[1],r[2],r[3]),l=0;l<c.blobs.length;l++)fillContour(a,c.blobs[l].contour,[255,0,0]);f=document.createElement("canvas").getContext("2d");f.canvas.width=r[2];f.canvas.height=r[3];v=f.getImageData(0,0,r[2],r[3]);v.data.set(a.data);f.putImageData(v,0,0);i.drawImage(f.canvas,0,0,r[2],r[3],r[0]+u[0],r[1]+u[1],r[2],r[3])}},ht=function(){var c,tt,h,k,n,it,u;if(l){if(b==="")return}else{if(r.paused){console.log("no video");return}e.drawImage(r,0,0,f,o,0,0,f,o)}if(c=e.getImageData(0,0,f,o),i.putImageData(c,0,0),st(c),t.faces.length>0&&(t.faces[0].rect[2]<nt||t.faces[0].rect[3]<nt?(a(t.faces[0],"\u0644\u0637\u0641\u0627 \u0646\u0632\u062f\u06cc\u06a9 \u0634\u0648\u06cc\u062f",100),g()):t.faces[0].eyes.length===0?a(t.faces[0],"\u0646\u0648\u0631 \u0646\u0627\u0645\u0646\u0627\u0633\u0628",65):s[0]>0?a(t.faces[0],"\u0644\u0637\u0641\u0627 \u062b\u0627\u0628\u062a \u0628\u0645\u0627\u0646\u06cc\u062f",85):blinks<y?a(t.faces[0],"\u0644\u0637\u0641\u0627 \u067e\u0644\u06a9 \u0628\u0632\u0646\u06cc\u062f "+blinks+" \u0627\u0632 "+y,110):(a(t.faces[0],"\u0644\u0637\u0641\u0627 \u0628\u0647 \u062f\u0648\u0631\u0628\u06cc\u0646 \u0628\u0646\u06af\u0631\u06cc\u062f",110),(y===0||d(t.faces[0])>0)&&(et(),g()))),!w&&new Date-t.endTime>500){if(w=!0,tt={faces:[]},l){h={Faces:[]};try{if(h=p.Content.slControl.DetectFaces(b),h)for(console.log((new Date).getTime()+" silverlight "+h.Duration),k=0;k<h.Faces.length;k++){for(n=h.Faces[k],it={rect:[n.Rect[0],n.Rect[1],n.Rect[2],n.Rect[3]],eyes:[]},u=0;u<n.Eyes.length;u++)it.eyes.push({rect:[n.Eyes[u][0],n.Eyes[u][1],n.Eyes[u][2],n.Eyes[u][3]]});tt.faces.push(it)}}catch(rt){console.log((new Date).getTime()+" DetectFaces Javascript Error: "+rt.message)}}v.postMessage({isSilverlight:l,imageData:c,silverData:tt})}},rt=function(){ht();requestAnimationFrame(rt)},ut=function(n,r){f=n;o=r;e.canvas.width=f;e.canvas.height=o;i.canvas.width=f;i.canvas.height=o;e.translate(f,0);e.scale(-1,1);v=new Worker("../js/Camera/worker_process.js?p="+(new Date).getTime());v.addEventListener("error",function(n){console.log(n.message+" ("+n.filename+":"+n.lineno+")")},!1);v.addEventListener("message",function(n){console.log((new Date).getTime()+" worker "+(n.data.endTime-n.data.startTime));u=t;t=n.data;ot();w=!1},!1);rt()};return ft(),navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia&&!0?(r.addEventListener("loadedmetadata",function(){ut(r.videoWidth,r.videoHeight)}),navigator.getUserMedia({video:!0,audio:!1},function(n){r.src=window.URL.createObjectURL(n);r.play()},function(n){console.log("camera access failure",n)})):Silverlight.isInstalled?(i.canvas.style.display="none",window.silverlightCameraLoaded=window.silverlightCameraLoaded||function(n){l=!0;p=n.getHost()},window.silverlightCameraError=window.silverlightCameraError||function(){},window.cameraCaptureStarted=window.cameraCaptureStarted||function(n,t){h.width=0;h.height=0;i.canvas.style.cssText="";ut(n,t)},window.cameraFrameCaptured=window.cameraFrameCaptured||function(n){b=n;var t=document.createElement("img");t.src="data:image/jpeg;base64,"+n;e.drawImage(t,0,0,f,o,0,0,f,o)},h=document.createElement("object"),h.type="application/x-silverlight-2",h.data="data:application/x-silverlight-2,",h.width="640",h.height="480",h.innerHTML='<param name="source" value="Silverlight/SilverCam.xap" /><param name="onLoad" value="silverlightCameraLoaded"/><param name="onError" value="silverlightCameraError" /><param name="windowless" value="True" /><param name="background" value="Transparent" /><param name="minRuntimeVersion" value="5.0.61118.0" /><param name="autoUpgrade" value="true" />',r.parentNode.insertBefore(h,r)):console.log("browser not supported"),c.start=function(){if(l)try{p.Content.slControl.Start()}catch(n){console.log((new Date).getTime()+" Start Javascript Error: "+n.message)}},c.stop=function(){if(l)try{p.Content.slControl.Stop()}catch(n){console.log((new Date).getTime()+" Stop Javascript Error: "+n.message)}},c};